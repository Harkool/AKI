# 利尿剂剂量与急性肾损伤：因果推断研究

[![DOI](https://img.shields.io/badge/DOI-待发布-orange)](https://github.com/Harkool/diuretic-aki-causal-inference)
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)
[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![R 4.0+](https://img.shields.io/badge/R-4.0+-blue.svg)](https://www.r-project.org/)

> **ICU患者利尿剂剂量与急性肾损伤风险关联的因果推断研究：多中心回顾性队列研究**

[English](README.md) | 简体中文

---

## 📋 目录

- [研究概述](#-研究概述)
- [核心特点](#-核心特点)
- [研究设计](#-研究设计)
- [数据集](#-数据集)
- [研究方法](#-研究方法)
- [安装说明](#-安装说明)
- [使用指南](#-使用指南)
- [研究结果](#-研究结果)
- [项目结构](#-项目结构)
- [引用格式](#-引用格式)
- [许可证](#-许可证)
- [联系方式](#-联系方式)

---

## 🔬 研究概述

本仓库包含**多中心回顾性队列研究**的代码和文档，研究ICU患者利尿剂剂量与急性肾损伤(AKI)风险之间的因果关系。

### 研究目标

**主要目标：**
- 评估利尿剂剂量与AKI发生的因果关系

**次要目标：**
1. 探索剂量-反应关系的形状（线性/阈值/非线性）
2. 识别高危人群（异质性分析）
3. 探索电解质紊乱的潜在关联作用
4. 为临床提供剂量优化建议

### 研究中心

- **新疆医科大学第一附属医院**
- **中南大学湘雅医院**

---

## ✨ 核心特点

🎯 **创新方法**
- 从"用不用"到"用多少"的范式转变
- 结合机器学习预测与因果推断
- 识别具有差异化治疗效应的患者亚组

🔧 **稳健方法学**
- 多种因果推断方法（PSM、IPTW、双重稳健）
- 全面的敏感性分析（E-value、不同模型设定）
- 机器学习检测异质性（因果森林、T-Learner）

📊 **临床相关性**
- 临床决策支持的风险分层系统
- 可操作的剂量优化建议
- 识别需要密切监测的脆弱人群

---

## 📐 研究设计

### 研究类型
基于电子病历(EHR)的多中心回顾性队列研究

### 研究人群
- **样本量：** 2,397例ICU患者
- **AKI发生率：** 394例（16.4%）
  - 1级：279例（11.6%）
  - 2级：64例（2.7%）
  - 3级：51例（2.1%）

### 纳入标准
1. ICU住院患者
2. 接受利尿剂治疗（呋塞米或托拉塞米）
3. 有完整的基线和用药后肌酐数据
4. 年龄≥18岁

### 排除标准
1. 入院时已有终末期肾病(ESRD)需要透析
2. 住院时间<48小时
3. 关键变量缺失>40%

---

## 📊 数据集

### 数据文件
`AKI.csv`

- **行数：** 2,398（含表头）
- **列数：** 67个变量
- **编码：** UTF-8 with BOM

### 关键变量

#### 主要暴露变量
- **利尿剂总剂量**（mg）

#### 主要结局变量
- **AKI分级**（KDIGO标准）
  - 0 = 未发生AKI
  - 1 = 1级（肌酐升高1.5-1.9倍或≥26.5 μmol/L）
  - 2 = 2级（肌酐升高2.0-2.9倍）
  - 3 = 3级（肌酐升高≥3.0倍或≥353.6 μmol/L或需要肾脏替代治疗）

#### 重要混杂因素
- 人口统计学：年龄、性别、民族
- 基线肾功能：肌酐、估算肾小球滤过率
- 合并症：糖尿病、高血压、心力衰竭、脓毒症
- 合并用药：NSAIDs、ACEI/ARB、造影剂、抗生素
- 实验室指标：电解质、血常规、肝功能

#### 次要结局
- 电解质紊乱（低钠、高钠、低钾、高钾）
- 肌酐变化（绝对值和相对值）

详细变量说明见 [数据字典](docs/data_dictionary.md)。

---

## 🛠 研究方法

### 五步分析框架

#### 第一步：预测模型构建
**目的：** 识别AKI风险因素，评估利尿剂剂量的预测重要性

**模型：**
- Logistic回归（基线模型）
- 随机森林
- XGBoost / LightGBM（主要模型）
- 深度学习（探索性）

**评估指标：**
- AUC-ROC、AUPRC
- 校准图、Brier评分
- 决策曲线分析
- SHAP值特征重要性

#### 第二步：因果推断分析
**目的：** 估计利尿剂剂量对AKI的因果效应

**剂量分层：**
- Q1（低剂量）：2-20 mg
- Q2（中低剂量）：>20-40 mg
- Q3（中高剂量）：>40-80 mg
- Q4（高剂量）：>80 mg

**方法：**
1. **倾向性评分匹配(PSM)**
   - 1:1最近邻匹配
   - 卡钳值：0.2×SD(logit PS)

2. **逆概率加权(IPTW)**
   - 倾向性评分估计
   - 权重计算和截断
   - 平衡性检查（SMD < 0.1）

3. **双重稳健估计**
   - 结合倾向性评分和结局模型
   - 增强稳健性

**效应估计：**
- 平均处理效应(ATE)
- 风险差(RD)
- 风险比(RR)
- 比值比(OR)
- 95%置信区间

**趋势检验：**
- Cochran-Armitage趋势检验
- 线性回归趋势分析

#### 第三步：关联路径探索
**研究问题：** 电解质紊乱是否在剂量-AKI关系中发挥作用？

⚠️ **重要说明：** 由于是单时间点数据，我们进行**关联路径分析**而非正式的因果中介分析。

**分析内容：**
1. 路径a：剂量 → 电解质紊乱
2. 路径b：电解质紊乱 → AKI（调整剂量）
3. 总效应：剂量 → AKI
4. 直接效应：剂量 → AKI（调整电解质）
5. 按电解质状态分层分析
6. 剂量-电解质-AKI联合分析

#### 第四步：异质性分析
**目的：** 识别对高剂量利尿剂更敏感的患者亚组

**传统亚组分析：**
- 按基线肾功能（eGFR）
- 按年龄（<65岁 vs. ≥65岁）
- 按糖尿病状态
- 按心力衰竭史
- 按利尿剂类型
- 按合并ACEI/ARB使用

**机器学习异质性分析：**

1. **T-Learner**
   - 估计个体处理效应(ITE)
   - 分析ITE分布
   - 识别高反应者vs低反应者

2. **因果森林**
   - CATE估计
   - 特征重要性分析
   - 最佳线性投影(BLP)
   - 解释异质性来源

**临床风险分层：**
- 低风险（评分0-1）
- 中风险（评分2-3）
- 高风险（评分4-6）

#### 第五步：敏感性分析
**目的：** 验证结果稳健性，评估潜在偏倚

**分析内容：**
1. **E-value分析：** 评估未测量混杂的影响
2. **方法对比：** PSM vs. IPTW vs. 双重稳健
3. **不同分组方案：** 三分位 vs. 四分位 vs. 五分位
4. **排除性分析：**
   - 排除极端剂量
   - 限制静脉给药患者
   - 完全病例分析
5. **负对照和正对照**
6. **剂量-反应关系形状检验：** 线性 vs. 阈值 vs. 非线性

---

## 💻 安装说明

### 环境要求

**Python依赖：**
```bash
python >= 3.8
numpy >= 1.20.0
pandas >= 1.3.0
scikit-learn >= 1.0.0
xgboost >= 1.5.0
lightgbm >= 3.3.0
shap >= 0.40.0
matplotlib >= 3.4.0
seaborn >= 0.11.0
```

**R依赖：**
```r
R >= 4.0.0
grf >= 2.0.0
MatchIt >= 4.0.0
cobalt >= 4.3.0
EValue >= 4.1.0
```

### 安装步骤

1. **克隆仓库**
```bash
git clone https://github.com/Harkool/diuretic-aki-causal-inference.git
cd diuretic-aki-causal-inference
```

2. **创建Python虚拟环境**
```bash
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
```

3. **安装Python依赖**
```bash
pip install -r requirements.txt
```

4. **安装R包**
```r
# 在R控制台运行
install.packages(c("grf", "MatchIt", "cobalt", "EValue", "tidyverse"))
```

---

## 🚀 使用指南

### 快速开始

1. **数据预处理**
```bash
python src/01_data_preprocessing.py
```

2. **预测模型**
```bash
python src/02_predictive_modeling.py
```

3. **因果推断**
```bash
python src/03_causal_inference.py
```

4. **异质性分析**
```r
# 在R中运行
source("src/04_heterogeneity_analysis.R")
```

5. **生成图表**
```bash
python src/05_generate_outputs.py
```

### 详细工作流

查看 [notebooks/](notebooks/) 获取分步Jupyter笔记本：
- `01_exploratory_analysis.ipynb` - 探索性分析
- `02_feature_engineering.ipynb` - 特征工程
- `03_prediction_models.ipynb` - 预测模型
- `04_causal_analysis.ipynb` - 因果分析
- `05_heterogeneity.ipynb` - 异质性分析
- `06_sensitivity_analysis.ipynb` - 敏感性分析

---

## 📈 研究结果

### 主要发现

**发现1：剂量-反应关系**
- AKI风险随剂量明确增加
- Q1（参照）：AKI率约13-15%
- Q4（高剂量）：AKI率约20-22%
- P趋势 < 0.001

**发现2：高剂量显著增加AKI风险**
- 高剂量(>80mg) vs. 低剂量(≤80mg)：
  - 风险差：6-8%
  - 风险比：1.4-1.5
  - 比值比：1.5-1.6
  - P < 0.001

**发现3：电解质紊乱的作用**
- 高剂量增加电解质紊乱风险
- 电解质紊乱与AKI相关
- 调整电解质后效应减弱但仍显著

**发现4：异质性效应**

**高危亚组（效应更强）：**
- 基线肾功能受损（肌酐较高）
- 年龄≥65岁
- 糖尿病
- 既往心力衰竭史
- 合并使用ACEI/ARB

### 输出结果

**主要表格：**
- 表1：按AKI分级的基线特征
- 表2：预测模型性能对比
- 表3：因果效应估计（剂量四分位）
- 表4：方法对比（PSM/IPTW/DR）
- 表5：关联路径分析
- 表6：亚组分析
- 表7：临床风险评分

**主要图表：**
- 图1：研究流程图
- 图2：预测模型结果（ROC/PR/校准/SHAP）
- 图3：剂量-反应曲线
- 图4：连续剂量-AKI风险
- 图5：关联路径
- 图6：亚组分析森林图
- 图7：异质性分析（ITE/特征重要性）
- 图8：临床风险分层
- 图9：敏感性分析森林图

所有输出见 [results/](results/) 和 [figures/](figures/)。

---

## 📁 项目结构

详见英文版README。

---

## 🔒 数据可用性

由于患者隐私保护和医院数据政策，完整数据集不公开。

发表后，在以下条件下可考虑合理的数据请求：
1. 明确的科学研究目的
2. 获得伦理委员会批准
3. 签署数据使用协议
4. 符合中国数据安全和隐私法律

请联系通讯作者申请数据访问。

---

## 📄 引用格式

如果在研究中使用本代码或数据，请引用：

```bibtex

```

**代码引用：**
```bibtex

}
```

---

## 📝 许可证

本项目采用MIT许可证 - 详见 [LICENSE](LICENSE) 文件。

**注意：** 许可证仅适用于代码。数据使用需遵守单独的数据使用协议和机构政策。

---

## 🙏 致谢

- **数据贡献单位：**
  - 新疆医科大学第一附属医院
  - 中南大学湘雅医院

- **技术支持：**
  - 中国药科大学天然药物活性组分与药效国家重点实验室
  - 中国药科大学药物代谢研究室

- **资助：**
  - [如适用，列出资助来源]

---

## 👤 联系方式

**刘昊**

📧 **邮箱：** lenhartkoo@foxmail.com

🏢 **单位：**  
中国药科大学  
天然药物活性组分与药效国家重点实验室  
药物代谢研究室  
江苏省南京市 210009

---

## 🔄 版本历史

- **v1.0.0** (2025-11-14): 初始版本
  - 多中心数据（新疆+湘雅）
  - 完整的五步分析框架
  - 全面的敏感性分析

---

## 🤝 贡献

欢迎贡献！请提交Pull Request。对于重大更改，请先开issue讨论。

**请确保：**
1. 适当更新测试
2. 遵循现有代码风格
3. 添加清晰的提交信息
4. 更新文档

---

## 📚 参考文献

详见英文版README。

---

## 📊 项目状态

![状态](https://img.shields.io/badge/状态-活跃-success)
![构建](https://img.shields.io/badge/构建-通过-success)
![覆盖率](https://img.shields.io/badge/覆盖率-85%25-yellowgreen)

**当前阶段：** 论文准备中

**下一步：**
- [ ] 完成最终分析
- [ ] 提交期刊
- [ ] 准备代码公开发布
- [ ] 创建详细文档
- [ ] 添加交互式可视化